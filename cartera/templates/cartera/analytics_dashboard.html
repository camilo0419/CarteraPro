{% extends "cartera/base.html" %}
{% load static %}

{% block title %}Analytics{% endblock %}

{% block content %}
<div class="analytics-scope">

  <h1 style="display:flex;align-items:center;gap:10px">
    üìä Tablero Anal√≠tico
    <span class="badge">CarteraPro</span>
  </h1>

  <!-- ===== Filtros ===== -->
  <form method="get" class="filters">
    <div class="field">
      <label for="f-pdv">Punto de venta</label>
      <select id="f-pdv" name="pdv">
        <option value="">Todos</option>
        {% for p in pdvs %}
          <option value="{{ p.id }}" {% if filters.pdv == p.id %}selected{% endif %}>{{ p.nombre }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="field">
      <label for="f-prov">Proveedor</label>
      <select id="f-prov" name="prov">
        <option value="">Todos</option>
        {% for p in provs %}
          <option value="{{ p.id }}" {% if filters.prov == p.id %}selected{% endif %}>{{ p.nombre }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="field">
      <label for="f-rango">Rango</label>
      <select id="f-rango" name="rango">
        <option value="mes_actual">Mes actual</option>
        <option value="mes_anterior">Mes anterior</option>
        <option value="ult_30">√öltimos 30 d√≠as</option>
        <option value="este_anio">Este a√±o</option>
        <option value="anio_pasado">A√±o pasado</option>
        <option value="personalizado">Personalizado</option>
      </select>
    </div>

    <div class="field">
      <label for="f-d1">Desde</label>
      <input id="f-d1" type="date" name="d1" value="{{ filters.d1 }}">
    </div>

    <div class="field">
      <label for="f-d2">Hasta</label>
      <input id="f-d2" type="date" name="d2" value="{{ filters.d2 }}">
    </div>

    <div class="actions">
      <a class="button outline" href="{% url 'analytics_dashboard' %}">Limpiar</a>
    </div>
  </form>

  <!-- ===== Estilos locales: grid y tooltips KPI ===== -->
  <style>
    .cards{display:grid;grid-template-columns:repeat(4,minmax(220px,1fr));gap:12px}
    @media(max-width:1024px){.cards{grid-template-columns:repeat(2,minmax(220px,1fr))}}
    @media(max-width:640px){.cards{grid-template-columns:1fr}}

    .card{position:relative;background:#fff;border:1px solid var(--border);
          border-radius:14px;padding:16px 16px 18px}
    .k{font-size:12px;color:#7a7a7a}
    .v{font-size:28px;font-weight:800;margin-top:4px}

    /* Bot√≥n ‚Äú‚ìò‚Äù sin √≥valo */
    .kpi-info{
      position:absolute;top:8px;right:10px;
      background:transparent;border:none;padding:0;margin:0;
      font-size:16px;line-height:1;color:#F57C00;cursor:help;
    }
    .kpi-info:hover,.kpi-info:focus{color:#d36700;outline:none}

    /* Tooltip */
    .kpi-info[data-tip]::after{
      content:attr(data-tip);position:absolute;top:22px;right:0;
      min-width:220px;max-width:320px;padding:10px 12px;
      background:#1f1f1f;color:#fff;font-size:12px;line-height:1.35;
      border-radius:10px;box-shadow:0 10px 20px rgba(0,0,0,.18);
      opacity:0;pointer-events:none;transform:translateY(-4px);
      transition:all .16s ease;z-index:50;white-space:normal
    }
    .kpi-info[data-tip]::before{
      content:"";position:absolute;top:16px;right:6px;width:8px;height:8px;
      background:#1f1f1f;transform:rotate(45deg);opacity:0;transition:all .16s ease
    }
    .kpi-info:hover::after,.kpi-info:focus::after{opacity:1;transform:translateY(0)}
    .kpi-info:hover::before,.kpi-info:focus::before{opacity:1}
  </style>

  <!-- ===== KPIs (4 por fila) ===== -->
  <div class="cards">
    <div class="card">
      <div class="k">Total compras</div>
      <button class="kpi-info" type="button" aria-label="Ayuda"
              data-tip="Suma de valor_factura dentro del rango seleccionado.">‚ìò</button>
      <div class="v">$<span class="money-es" data-v="{{ kpi_total|floatformat:0|default:'0' }}">{{ kpi_total|floatformat:0 }}</span></div>
    </div>

    <div class="card">
      <div class="k">Facturas</div>
      <button class="kpi-info" type="button" data-tip="N√∫mero de facturas en el rango elegido.">‚ìò</button>
      <div class="v">{{ kpi_facturas|default:"0" }}</div>
    </div>

    <div class="card">
      <div class="k">Pagado</div>
      <button class="kpi-info" type="button" data-tip="Suma de valor_pagado de las facturas del per√≠odo filtrado.">‚ìò</button>
      <div class="v">$<span class="money-es" data-v="{{ kpi_pagado|floatformat:0|default:'0' }}">{{ kpi_pagado|floatformat:0 }}</span></div>
    </div>

    <div class="card">
      <div class="k">Prom. d√≠as pago</div>
      <button class="kpi-info" type="button" data-tip="D√≠as promedio entre fecha de factura y fecha de pago (solo facturas con pago).">‚ìò</button>
      <div class="v">{{ kpi_dias|default:"0" }}</div>
    </div>

    <div class="card">
      <div class="k">Valor pendiente</div>
      <button class="kpi-info" type="button" data-tip="Suma del saldo de todas las facturas pendientes. Ignora el rango; respeta PDV/Proveedor.">‚ìò</button>
      <div class="v">$<span class="money-es" data-v="{{ kpi_valor_pendiente|floatformat:0|default:'0' }}">{{ kpi_valor_pendiente|floatformat:0 }}</span></div>
    </div>

    <div class="card">
      <div class="k"># Pendientes</div>
      <button class="kpi-info" type="button" data-tip="Cantidad de facturas pendientes. Ignora el rango; respeta PDV/Proveedor.">‚ìò</button>
      <div class="v">{{ kpi_num_pendientes|default:"0" }}</div>
    </div>

    <div class="card">
      <div class="k">% Pagado vs Compras</div>
      <button class="kpi-info" type="button" data-tip="Relaci√≥n de lo pagado frente al total de compras del per√≠odo.">‚ìò</button>
      <div class="v">{{ kpi_pct_pagado|default:"0" }}%</div>
    </div>

    <div class="card">
      <div class="k">% Pagos contado</div>
      <button class="kpi-info" type="button" data-tip="Porcentaje de pagos del per√≠odo que fueron 'contado en PDV'.">‚ìò</button>
      <div class="v">{{ kpi_pct_contado|default:"0" }}%</div>
    </div>

    <div class="card">
      <div class="k">Tasa confirmaci√≥n</div>
      <button class="kpi-info" type="button" data-tip="Entre facturas con pago en el per√≠odo, porcentaje confirmadas por el proveedor.">‚ìò</button>
      <div class="v">{{ kpi_tasa_conf|default:"0" }}%</div>
    </div>

    <div class="card">
      <div class="k">Cobertura comprobantes</div>
      <button class="kpi-info" type="button" data-tip="Porcentaje de pagos del per√≠odo con comprobante adjunto.">‚ìò</button>
      <div class="v">{{ kpi_cob_comp|default:"0" }}%</div>
    </div>

    <div class="card">
      <div class="k">Top proveedor (share)</div>
      <button class="kpi-info" type="button" data-tip="Participaci√≥n del proveedor con m√°s compras en el per√≠odo.">‚ìò</button>
      <div class="v">{{ kpi_share_top1|default:"0" }}%</div>
    </div>

    <div class="card">
      <div class="k">Top 3 (share)</div>
      <button class="kpi-info" type="button" data-tip="Participaci√≥n conjunta de los 3 proveedores l√≠deres del per√≠odo.">‚ìò</button>
      <div class="v">{{ kpi_share_top3|default:"0" }}%</div>
    </div>

    <div class="card">
      <div class="k">Œî vs mes anterior</div>
      <button class="kpi-info" type="button" data-tip="Variaci√≥n % del mes actual vs mes anterior (solo cuando el rango es 'Mes actual').">‚ìò</button>
      <div class="v">
        {% if kpi_delta_mes_ant is not None %}
          {{ kpi_delta_mes_ant }}% &nbsp;
          <small class="muted">($<span class="money-es" data-v="{{ kpi_delta_monto|floatformat:0|default:'0' }}">{{ kpi_delta_monto|floatformat:0 }}</span>)</small>
        {% else %} ‚Äî {% endif %}
      </div>
    </div>

    <div class="card">
      <div class="k">Nuevas (7 d√≠as)</div>
      <button class="kpi-info" type="button" data-tip="Facturas creadas en los √∫ltimos 7 d√≠as (independiente del rango; respeta PDV/Proveedor).">‚ìò</button>
      <div class="v">{{ kpi_nuevas_7d|default:"0" }}</div>
    </div>

    <div class="card">
      <div class="k">Antig√ºedad prom. (pend.)</div>
      <button class="kpi-info" type="button" data-tip="Promedio de d√≠as desde la fecha de cada factura pendiente hasta hoy. Ignora el rango.">‚ìò</button>
      <div class="v">{{ kpi_antig_pend|default:"0" }}</div>
    </div>

    <div class="card">
      <div class="k">Ticket prom. (pend.)</div>
      <button class="kpi-info" type="button" data-tip="Saldo promedio por factura pendiente (Total pendiente / # pendientes). Ignora el rango.">‚ìò</button>
      <div class="v">$<span class="money-es" data-v="{{ kpi_ticket_pend|floatformat:0|default:'0' }}">{{ kpi_ticket_pend|floatformat:0 }}</span></div>
    </div>
  </div>

  <!-- ===== Gr√°ficas ===== -->
  <div class="table-card" style="padding:14px; margin-top:16px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <b>Top Proveedores</b>
      <small style="color:var(--muted)">clic para filtrar por proveedor</small>
    </div>
    <canvas id="topProveedores"></canvas>
  </div>

  <div class="table-card" style="padding:14px; margin-top:16px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <b>Compras por PDV</b>
      <small style="color:var(--muted)">clic para filtrar por PDV</small>
    </div>
    <canvas id="comprasPorPDV" height="160"></canvas>
  </div>

  <div class="table-card" style="padding:14px; margin-top:16px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <b>Compras por Mes</b>
      <small style="color:var(--muted)">clic en el mes para aplicar rango</small>
    </div>
    <canvas id="comprasMensuales" height="120"></canvas>
  </div>

  <div class="table-card" style="padding:14px; margin-top:16px;">
    <h2>Top Facturas</h2>
    <table>
      <thead>
        <tr>
          <th>Fecha</th><th>N.¬∫</th><th>Proveedor</th><th>PDV</th>
          <th class="col-money">Valor</th><th style="text-align:center;">Detalle</th>
        </tr>
      </thead>
      <tbody>
        {% for f in top_facturas %}
        <tr>
          <td>{{ f.fecha_factura|date:"d/m/Y" }}</td>
          <td>{{ f.numero_factura }}</td>
          <td>{{ f.proveedor__nombre }}</td>
          <td>{{ f.punto_venta__nombre }}</td>
          <td class="col-money">$<span class="money-es" data-v="{{ f.valor_factura|floatformat:0|default:'0' }}">{{ f.valor_factura|floatformat:0 }}</span></td>
          <td style="text-align:center;">
            <a class="icon-btn" href="{% url 'factura_detalle' f.id %}?next={{ request.get_full_path|urlencode }}" title="Ver factura">üëÅ</a>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="6">No hay datos para los filtros seleccionados.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
Chart.defaults.font.family = 'system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif';
Chart.defaults.font.size = 12;
Chart.defaults.color = '#1a1a1a';

const NARANJA = 'rgba(245, 124, 0, 0.9)';
const NARANJA_SUAVE = 'rgba(255, 193, 112, .8)';
const AZUL = 'rgba(37, 99, 235, 0.9)';

function $(id){ return document.getElementById(id); }
function go(patch){
  const url = new URL(window.location.href);
  for (const [k,v] of Object.entries(patch)){
    if (v === '' || v === null || v === undefined) url.searchParams.delete(k);
    else url.searchParams.set(k, v);
  }
  window.location.replace(url.toString());
}

/* Filtros din√°micos (mes actual por defecto) */
(function(){
  const params = new URLSearchParams(location.search);
  const rangoSel = $('f-rango');
  rangoSel.value = params.get('rango') || 'mes_actual';

  $('f-pdv').addEventListener('change', e => go({ pdv: e.target.value || null }));
  $('f-prov').addEventListener('change', e => go({ prov: e.target.value || null }));

  rangoSel.addEventListener('change', e => {
    const r = e.target.value; if (r === 'personalizado') return;
    const { d1, d2 } = rangeDates(r); go({ rango: r, d1, d2 });
  });

  $('f-d2').addEventListener('change', () => {
    const d1 = $('f-d1').value, d2 = $('f-d2').value;
    if (d1 && d2) go({ rango:'personalizado', d1, d2 });
  });

  const sync=()=>{ $('f-d2').min=$('f-d1').value||''; $('f-d1').max=$('f-d2').value||''; };
  $('f-d1').addEventListener('change', sync); $('f-d2').addEventListener('change', sync); sync();
})();

/* Fechas util */
function iso(y,m,d){ return new Date(y,m,d).toISOString().slice(0,10); }
function today(){ const t=new Date(); return iso(t.getFullYear(),t.getMonth(),t.getDate()); }
function addDays(dt,n){ const d=new Date(dt); d.setDate(d.getDate()+n); return d; }
function rangeDates(key){
  const now = new Date();
  switch(key){
    case 'mes_actual':   return { d1: new Date(now.getFullYear(), now.getMonth(), 1).toISOString().slice(0,10), d2: today() };
    case 'mes_anterior': { const p = new Date(now.getFullYear(), now.getMonth()-1, 1);
                           const last = new Date(p.getFullYear(), p.getMonth()+1, 0);
                           return { d1: p.toISOString().slice(0,10), d2: last.toISOString().slice(0,10) }; }
    case 'ult_30':       { const end=new Date(); const start=addDays(end,-29);
                           return { d1: start.toISOString().slice(0,10), d2: end.toISOString().slice(0,10) }; }
    case 'este_anio':    return { d1: iso(now.getFullYear(),0,1), d2: today() };
    case 'anio_pasado':  return { d1: iso(now.getFullYear()-1,0,1), d2: iso(now.getFullYear()-1,11,31) };
    default:             return { d1: $('f-d1').value, d2: $('f-d2').value };
  }
}

/* Formato pesos */
function formatMoneyES(){
  document.querySelectorAll('.money-es').forEach(el=>{
    const raw=el.getAttribute('data-v')||el.textContent;
    const n=Number(String(raw).replace(/[^\d.-]/g,'')); if(!isNaN(n)) el.textContent=n.toLocaleString('es-CO');
  });
}
document.addEventListener('DOMContentLoaded', formatMoneyES);

/* Data desde Django */
const TOP_PROV = JSON.parse('{{ top_prov_json|escapejs }}');
const POR_PDV  = JSON.parse('{{ por_pdv_json|escapejs }}');
const BY_MONTH = JSON.parse('{{ by_month_json|escapejs }}');

/* Gr√°ficas */
(function(){
  if(!TOP_PROV.length) return;
  const isMobile=window.matchMedia('(max-width:768px)').matches;
  const strip=s=>s.replace(/\b(S\.?A\.?S?\.?|SAS|S\.?A\.?|LTDA|Ltda|S\. en C\.)\b/gi,'').trim();
  const ab=s=>{const b=strip(s),m=isMobile?18:28;return b.length>m?b.slice(0,m)+'‚Ä¶':b;};
  const labelsFull=TOP_PROV.map(x=>x.nombre), labels=TOP_PROV.map(x=>ab(x.nombre)), data=TOP_PROV.map(x=>x.total);
  const canvas=$('topProveedores'); canvas.height=isMobile?Math.max(260,labels.length*26+40):320;
  new Chart(canvas,{type:'bar',data:{labels,datasets:[{data,backgroundColor:NARANJA}]},
    options:{indexAxis:isMobile?'y':'x',maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{
      title:it=>labelsFull[it[0].dataIndex],label:ctx=>'$'+(isMobile?ctx.parsed.x:ctx.parsed.y).toLocaleString('es-CO')}}},
      scales:isMobile?{x:{ticks:{callback:v=>'$'+v.toLocaleString('es-CO')}},y:{ticks:{autoSkip:false,maxTicksLimit:labels.length}}}
                      :{y:{ticks:{callback:v=>'$'+v.toLocaleString('es-CO')}}},
      onClick:(e,els)=>{ if(!els||!els.length) return; const i=els[0].index; go({prov:TOP_PROV[i].id}); }
  }});
})();
if(POR_PDV.length){ new Chart($('comprasPorPDV'),{type:'bar',data:{
  labels:POR_PDV.map(x=>x.nombre),
  datasets:[{data:POR_PDV.map(x=>x.total),backgroundColor:NARANJA_SUAVE,borderColor:NARANJA,borderWidth:2}]},
  options:{indexAxis:'y',maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{
    label:ctx=>'$'+(ctx.parsed.x||0).toLocaleString('es-CO')}}},scales:{x:{ticks:{callback:v=>'$'+v.toLocaleString('es-CO')}}},
    onClick:(e,els)=>{ if(!els||!els.length) return; const i=els[0].index; go({pdv:POR_PDV[i].id}); }}}); }
if(BY_MONTH.length){ new Chart($('comprasMensuales'),{type:'line',data:{
  labels:BY_MONTH.map(x=>new Date(x.m).toLocaleDateString('es-CO',{month:'short',year:'2-digit'})),
  datasets:[{data:BY_MONTH.map(x=>x.total),borderColor:AZUL,backgroundColor:'rgba(37,99,235,.12)',fill:true,tension:.3}]},
  options:{maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{
    label:ctx=>'$'+(ctx.parsed.y||0).toLocaleString('es-CO')}}},scales:{y:{ticks:{callback:v=>'$'+v.toLocaleString('es-CO')}}},
  onClick:(e,els)=>{ if(!els||!els.length) return; const i=els[0].index; const first=new Date(BY_MONTH[i].m);
    const d1=first.toISOString().slice(0,10); const last=new Date(first.getFullYear(),first.getMonth()+1,0);
    const d2=last.toISOString().slice(0,10); go({rango:'personalizado',d1,d2}); }}}); }
</script>
{% endblock %}
